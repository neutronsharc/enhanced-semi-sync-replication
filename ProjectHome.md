**In MySQL5.7, the problem has been fixed by add a new parameter "rpl\_semi\_sync\_master\_wait\_point". With setting  rpl\_semi\_sync\_master\_wait\_point=AFTER\_SYNC,MySQL5.7 act just like this patch. Have a try.**

Related [Bug@MySQL](http://bugs.mysql.com/bug.php?id=62174)  [MariaDB DevelopmentMDEV-162](https://mariadb.atlassian.net/browse/MDEV-162)  [discuss@mail-list](http://lists.mysql.com/replication/2196)



The ESR is short for Enhanced Semi-sync Replication, and the patch is released here(Based on Percona-Server-5.5.15).

# Why not use the original semi-sync? #
The Google's [original semi-sync](http://code.google.com/p/google-mysql-tools/wiki/SemiSyncReplicationDesign) is cool.But it's not enough.

Once you use Semi-sync,it mean that you really care about your data. You wanna make sure that once you commit the transaction, the slave must get the binary log.

When InnoDB commit a transaction and no slave have accept the binary log, at the time another new thread still can read the data generated by this transaction. If database crash and gone(can't startup anymore) at this time, although we have ever read these data, it's not exist in any slave and we think this transaction is never happened. We call the data we read "phantom data".

The thing is: We can read the data some time, but after crash, i can not get the data(transaction) any more.

In my company's architecture, if our "new worker thread" read the "phantom data", we will try to do some work about user's critical information. So we must not read any "phantom data". That's why Enhanced Semi-sync Replication comes.

# How to use the ESR #
I publish this as a patch based on Percona-Server-5.5.15. I hope this can be merge into the main tree of Percona Server or MySQL Community Server ,so than i do not need maintain it at google code.

  * Download [Percona-Server-5.5.15-rel21.0.tar.gz](http://www.percona.com/downloads/Percona-Server-5.5/Percona-Server-5.5.15-21.0/source/)
  * Checkout the patch from google code: [Google Code SVN](http://code.google.com/p/enhanced-semi-sync-replication/source/checkout).
  * tar zxf Percona-Server-5.5.15-rel21.0.tar.gz
  * patch -p0 < ESR.percona.5.5.15.patch
  * patch -p0 < ESR.percona.5.5.15.fix-bug-44058.patch
  * Compile the Server: cmake . -DCMAKE\_INSTALL\_PREFIX=/opt/mysql  -DEXTRA\_CHARSETS=all && make -j 8 && make install ...
  * configure the semi-sync with **rpl\_semi\_sync\_master\_wait\_before\_commit=1** in my.cnf ,so something like this:
```
## semi-sync master ##
plugin_load=rpl_semi_sync_master=semisync_master.so
rpl_semi_sync_master_enabled=1
rpl_semi_sync_master_timeout=5000
rpl_semi_sync_master_trace_level=32
rpl_semi_sync_master_wait_before_commit=1

sync_binlog=1
```

# The difference between original semi-sync and the ESR #

The original Semi-sync in MySQL 5.5 only can make sure:
Once you **get response** from the master, there MUST BE binary log on at least TWO host.

As ESR make sure:
Once you can **read** the data from the master, there MUST BE binary log on at least TWO host.

The original semi-sync:

[![](http://farm7.static.flickr.com/6181/6145624937_0cfb0a4e6a.jpg)](http://www.flickr.com/photos/26825745@N06/6145624937/in/photostream)

The ESR:

[![](http://farm7.static.flickr.com/6179/6145626791_0fd77a4bae.jpg)](http://www.flickr.com/photos/26825745@N06/6145626791/in/photostream)

So ,the ESR are stronger than the original one, And the performance is almost the same.

# The Performance of ESR #

Turning Semi-sync on, it mean data is more safety, with less performance. Since the network is good and the hardware is fabulous, even turning Semi-sync /  rpl\_semi\_sync\_master\_wait\_before\_commit ON , still MySQL can finish thousands transaction per second.

In my IO bound test,the "UPDATE" performance is about 7% overhead, and "INSERT" is about 15% overhead.

The "UPDATE":
[![](http://farm7.static.flickr.com/6080/6145659563_a16b4b7178.jpg)](http://www.flickr.com/photos/26825745@N06/6145659563/)

The "INSERT"
[![](http://farm7.static.flickr.com/6177/6166121618_e19d7f367a.jpg)](http://www.flickr.com/photos/26825745@N06/6166121618/)

# Is this patch stable #

## It's in our product enviroment ##

It's hard to say. But I have run this verion in our product enviroment about 2 week, everything go fine.

## The test case ##

I have run all the test-suite in suite/rpl and turn this ON or OFF the result is exactly the same.

And a new test case has been added to the test case. It try to verify ESR always working.

## the code reviewer ##

I have ask for some MySQL experts to review the code:
anders song who is active in MySQL Replication Feature.

I do not know many MySQL experts. If your would like to help the project to do code-review, it very thankful.

# Why not merge this to MySQL #
First, We are not sure how this patch can help the other, although it helps me a lot.

I am still trying to merge this to MySQL Community Sever, but i it's not easy to community with MySQL/SUN/Oracle.inc.

# Contact with me #
orczhou#####gmail.com [![](http://www.orczhou.com/tns/mymail.png)](http://www.orczhou.com)